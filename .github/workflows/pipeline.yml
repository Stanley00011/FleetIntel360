name: Fleet Data Pipeline

on:
  schedule:
    # 6:00 UTC 
    - cron: '0 6 * * *'
  workflow_dispatch: 

jobs:
  run-fleet-intel:
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      CLOUD_SLACK_WEBHOOK: ${{ secrets.CLOUD_SLACK_WEBHOOK }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/service_account.json

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest

      - name: Create Service Account Key File
        run: echo '${{ secrets.GCP_SA_KEY }}' > ${{ github.workspace }}/service_account.json

      - name: Run Rigor Tests
        # If tests fail here, the whole pipeline stops (safety first!)
        run: pytest tests/

      - name: Run Simulator (Zero-Cost Mode)
        run: python -m simulator.run_simulation --mode pubsub --days 1 --limit 50

      - name: Run dbt Transformations
        working-directory: ./dbt_fleet_intel
        run: dbt run --target prod --profiles-dir .

      - name: Dispatch Slack Alerts
        run: python monitor_alerts.py