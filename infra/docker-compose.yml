services:
  simulator:
    build: 
      context: ..
      dockerfile: infra/Dockerfile
    env_file: ../.env
    command: python -m simulator.run_simulation --mode pubsub --days 1 --telemetry-per-day 50

  dbt_transform:
    build:
      context: ..
      dockerfile: infra/Dockerfile
    working_dir: /app/dbt_fleet_intel
    env_file: ../.env
    command: >
      sh -c "dbt deps && dbt run --target prod --profiles-dir ."
    depends_on:
      - simulator

  alerts:
    build:
      context: ..
      dockerfile: infra/Dockerfile
    env_file: ../.env
    command: python monitor_alerts.py
    depends_on:
      dbt_transform:
        condition: service_completed_successfully

  dashboard:
    build:
      context: ..
      dockerfile: infra/Dockerfile
    env_file: ../.env
    ports:
      - "9000:8080"
    command: streamlit run dashboard/app.py --server.port=8080 --server.address=0.0.0.0
    depends_on:
      - alerts